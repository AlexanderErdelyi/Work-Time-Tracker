name: Create Release

'on':
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release
    runs-on: windows-latest
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # For workflow_dispatch, checkout main and create tag; for push, checkout the tag
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || github.ref }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: Extract version from tag
        id: get_version
        shell: pwsh
        run: |
          # Get tag name from either push event or manual input
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tagName = "${{ inputs.tag }}"
          } else {
            $tagName = "${{ github.ref_name }}"
          }
          
          $version = $tagName -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "TAG_NAME=$tagName" >> $env:GITHUB_OUTPUT
          echo "Building version: $version"
      
      - name: Create and push tag (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        shell: pwsh
        run: |
          $tagName = "${{ steps.get_version.outputs.TAG_NAME }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if tag already exists remotely
          git fetch --tags
          if (git rev-parse "$tagName" 2>$null) {
            Write-Host "Tag $tagName already exists, skipping creation"
          } else {
            # Create and push the tag
            git tag -a "$tagName" -m "Release $tagName"
            git push origin "$tagName"
            Write-Host "Created and pushed tag $tagName"
          }
      
      - name: Update version.json
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          $versionFile = Get-Content "version.json" | ConvertFrom-Json
          $versionFile.version = $version
          $versionFile.releaseDate = (Get-Date -Format "yyyy-MM-dd")
          $versionFile | ConvertTo-Json -Depth 10 | Set-Content "version.json"
      
      - name: Build self-contained application
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          
          # Create Release directory
          New-Item -ItemType Directory -Path ".\Release" -Force | Out-Null
          
          # Publish self-contained for Windows x64
          dotnet publish Timekeeper.Api/Timekeeper.Api.csproj `
            --configuration Release `
            --runtime win-x64 `
            --self-contained true `
            --output ".\Release\Timekeeper-v$version-win-x64" `
            /p:PublishSingleFile=true `
            /p:PublishTrimmed=true `
            /p:EnableCompressionInSingleFile=true
          
          # Publish Tray App (system tray launcher)
          dotnet publish Timekeeper.TrayApp/Timekeeper.TrayApp.csproj `
            --configuration Release `
            --runtime win-x64 `
            --self-contained true `
            --output ".\Release\Timekeeper-v$version-win-x64" `
            /p:PublishSingleFile=true `
            /p:PublishTrimmed=true `
            /p:EnableCompressionInSingleFile=true
          
          $distFolder = ".\Release\Timekeeper-v$version-win-x64"
          
          # Copy documentation
          Copy-Item ".\README.md" -Destination $distFolder
          Copy-Item ".\SETUP_GUIDE.md" -Destination $distFolder
          Copy-Item ".\SIMPLE_USER_GUIDE.md" -Destination $distFolder
          Copy-Item ".\DISTRIBUTION_GUIDE.md" -Destination $distFolder
          Copy-Item ".\version.json" -Destination $distFolder
          
          # Create START_HERE.txt
          $startHere = "# Timekeeper v$version`n`n"
          $startHere += "## Quick Start`n`n"
          $startHere += "### Option 1: System Tray (Recommended)`n"
          $startHere += "- Double-click Timekeeper.TrayApp.exe`n"
          $startHere += "- The app will run in the system tray (bottom-right icons)`n"
          $startHere += "- Right-click the tray icon to start/stop or open the app`n"
          $startHere += "- No console window will appear!`n`n"
          $startHere += "### Option 2: Command Window`n"
          $startHere += "- Double-click START_TIMEKEEPER.bat`n"
          $startHere += "- Your browser will open automatically`n"
          $startHere += "- A console window will remain open`n`n"
          $startHere += "### To Stop:`n"
          $startHere += "- System Tray: Right-click tray icon > Exit`n"
          $startHere += "- Command Window: Close the console window or press Ctrl+C`n`n"
          $startHere += "## Your Data`n"
          $startHere += "All your data is saved in 'timekeeper.db' in this folder.`n"
          $startHere += "**IMPORTANT**: Backup this file regularly!`n`n"
          $startHere += "## Need Help?`n"
          $startHere += "See SIMPLE_USER_GUIDE.md for detailed instructions.`n`n"
          $startHere += "## Features`n"
          $startHere += "- No installation required - everything is included!`n"
          $startHere += "- No .NET Runtime needed`n"
          $startHere += "- Your data stays on your computer`n"
          $startHere += "- Offline application - works without internet`n"
          $startHere += "- Runs in system tray - no disturbing windows!`n`n"
          $startHere += "Enjoy!`n"
          
          Set-Content -Path "$distFolder\START_HERE.txt" -Value $startHere -Encoding UTF8
          
          # Create START_TIMEKEEPER.bat (legacy option)
          $batchContent = "@echo off`r`n"
          $batchContent += "title Timekeeper - Time Tracking Application`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "echo ================================================`r`n"
          $batchContent += "echo   Timekeeper is starting...`r`n"
          $batchContent += "echo ================================================`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "echo The application will open in your default browser.`r`n"
          $batchContent += "echo If it doesn't open automatically, go to:`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "echo    http://localhost:5000`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "echo To STOP the application, close this window or press Ctrl+C`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "echo ================================================`r`n"
          $batchContent += "echo.`r`n"
          $batchContent += "`r`n"
          $batchContent += "start http://localhost:5000`r`n"
          $batchContent += "`r`n"
          $batchContent += "Timekeeper.Api.exe`r`n"
          $batchContent += "`r`n"
          $batchContent += "pause`r`n"
          
          Set-Content -Path "$distFolder\START_TIMEKEEPER.bat" -Value $batchContent -Encoding ASCII
          
          # Create ZIP
          $zipPath = ".\Release\Timekeeper-v$version-win-x64.zip"
          Compress-Archive -Path $distFolder -DestinationPath $zipPath -Force
      
      - name: Generate release notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ steps.get_version.outputs.VERSION }}"
          
          # Read changelog from version.json
          $versionFile = Get-Content "version.json" | ConvertFrom-Json
          $changelog = $versionFile.changelog.$version
          
          $releaseNotes = "# Timekeeper v$version`n`n"
          $releaseNotes += "Released: $(Get-Date -Format 'yyyy-MM-dd')`n`n"
          $releaseNotes += "## âœ¨ What's New`n`n"
          
          if ($changelog -and $changelog.changes) {
            foreach ($change in $changelog.changes) {
              $releaseNotes += "- $change`n"
            }
          } else {
            $releaseNotes += "- See version.json for details`n"
          }
          
          $releaseNotes += "`n`n## ðŸ“¥ Download & Installation`n`n"
          $releaseNotes += "### For Non-Technical Users (Recommended) ðŸŒŸ`n`n"
          $releaseNotes += "1. Download **Timekeeper-v$version-win-x64.zip** below`n"
          $releaseNotes += "2. Extract the ZIP file to any folder`n"
          $releaseNotes += "3. Double-click **START_TIMEKEEPER.bat**`n"
          $releaseNotes += "4. Your browser opens automatically - start tracking time!`n`n"
          $releaseNotes += "**No installation required! No .NET needed!**`n`n"
          $releaseNotes += "ðŸ“– See **SIMPLE_USER_GUIDE.md** (included in ZIP) for detailed instructions.`n`n"
          $releaseNotes += "### Features`n`n"
          
          if ($versionFile.features) {
            foreach ($feature in $versionFile.features) {
              $releaseNotes += "- $feature`n"
            }
          }
          
          $releaseNotes += "`n`n### âš™ï¸ Requirements`n`n"
          $releaseNotes += "- Windows 10 or 11 (64-bit)`n"
          $releaseNotes += "- No other software needed!`n`n"
          $releaseNotes += "### ðŸ“ Important Notes`n`n"
          $releaseNotes += "- **Your data**: Stored in ``timekeeper.db`` file - backup regularly!`n"
          $releaseNotes += "- **Offline**: Works without internet connection`n"
          $releaseNotes += "- **Privacy**: All data stays on your computer`n"
          $releaseNotes += "- **Portable**: Copy folder to USB or anywhere`n`n"
          $releaseNotes += "### ðŸ†˜ Need Help?`n`n"
          $releaseNotes += "- Read **SIMPLE_USER_GUIDE.md** for step-by-step instructions`n"
          $releaseNotes += "- Check **SETUP_GUIDE.md** for troubleshooting`n"
          $releaseNotes += "- Open an issue on GitHub`n`n"
          $releaseNotes += "---`n`n"
          $releaseNotes += "## ðŸ”„ Updating from Previous Version`n`n"
          $releaseNotes += "1. Backup your **timekeeper.db** file`n"
          $releaseNotes += "2. Download and extract new version`n"
          $releaseNotes += "3. Copy your **timekeeper.db** into new folder`n"
          $releaseNotes += "4. Run START_TIMEKEEPER.bat`n`n"
          $releaseNotes += "Your data will be preserved! âœ…`n"
          
          # Save to file for GitHub release
          $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
          
          # Set output (escape for GitHub Actions)
          $releaseNotes = $releaseNotes -replace '%','%25' -replace '\n','%0A' -replace '\r','%0D'
          echo "NOTES=$releaseNotes" >> $env:GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
          name: Timekeeper v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            Release/Timekeeper-v${{ steps.get_version.outputs.VERSION }}-win-x64.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
